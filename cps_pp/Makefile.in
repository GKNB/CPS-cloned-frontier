# CPS makefile
# $Id: Makefile.in,v 1.19 2004-09-21 18:05:24 chulwoo Exp $
# @configure_input@

SRCDIR = @abs_top_srcdir@
BUILDDIR = @abs_builddir@
TESTDIR = tests
DOCDIR = doc
QOS = @QOS@

ifneq "$(BUILDDIR)"  "$(SRCDIR)"
builddir_isnt_srcdir="yes"
else
builddir_isnt_srcdir=
endif

all: recurse copy_testdir

cps: recurse

depend: recurse

clean: recurse

buildlib: recurse

recurse:
	mkdir -p $(BUILDDIR)/objs
	touch -a $(BUILDDIR)/objs/Makefile_depend
	cp -p $(SRCDIR)/src/Makefile $(BUILDDIR)/objs
	$(MAKE) -C $(BUILDDIR)/objs $(filter-out test, $(MAKECMDGOALS))


cleanlib: 
	rm -f *.a

copy_makefile:
	-cp $(BUILDDIR)/Makefile $(BUILDDIR)/Makefile.rules ${SRCDIR}
	-cp $(BUILDDIR)/$(TESTDIR)/Makefile_common* ${SRCDIR}/$(TESTDIR)
	-cp $(BUILDDIR)/$(TESTDIR)/regression.pl ${SRCDIR}/$(TESTDIR)

copy_include:
	$(if $(builddir_isnt_srcdir), 
	rm -rf $(BUILDDIR)/include; cp -r $(SRCDIR)/include $(BUILDDIR))

TESTSUBDIRS :=$(shell ls -p $(SRCDIR)/$(TESTDIR)/*/Makefile_regression)
TESTSUBDIRS :=$(dir $(TESTSUBDIRS))
TESTSUBDIRS :=$(patsubst $(SRCDIR)/$(TESTDIR)/%/, %, $(TESTSUBDIRS))

copy_testdir: $(TESTSUBDIRS)
	$(if $(findstring s, $(MAKEFLAGS)),,@echo TESTSUBDIRS = $(TESTSUBDIRS))

$(TESTSUBDIRS):
	$(if $(builddir_isnt_srcdir), mkdir -p $(TESTDIR)/$@)
	-cp -p $(SRCDIR)/$(TESTDIR)/$@/Makefile_regression  $(TESTDIR)/$@
#  Create the documentation

have_doxygen = @have_doxygen@

ifneq "$(have_doxygen)" "yes"

docs webdocs:
	@echo doxygen must be installed to make the documentation.
else

docs:
docs: 
	$(if $(builddir_isnt_srcdir), cp -r $(SRCDIR)/$(DOCDIR) $(BUILDDIR))
	bash $(BUILDDIR)/$(DOCDIR)/mkdocs.sh $(SRCDIR)

#  Documentation for the web pages
#  (this deletes the source code so that it is not posted on the web)

docsubdirs = $(dir $(shell ls doc/*/Makefile))
webdocs:
	@echo Creating documentation for the web page
	$(if $(builddir_isnt_srcdir),, @echo This will delete all source code!)
	$(MAKE)  docs
	$(if $(builddir_isnt_srcdir),, @rm -rf src include tests)
	@for a in $(docsubdirs); do $(MAKE) -C $$a all clean; done
	chmod o= `ls`
	@find $(DOCDIR) -path "*CVS" -prune -o -type d -print | xargs chmod 775
	@find $(DOCDIR) -name "*.html" -o -name "*.*ps" -o -name "*.gif" -o -name "*.png" -o -name "*.jp*g" -o -name "*.pdf" -o -name "*.tar.gz" |xargs chmod 644

endif

#  Run the regression test suite

test: cps
	-cp $(TESTDIR)/Makefile_common tests/regression.pl $(SRCDIR)/${TESTDIR}
	cd $(SRCDIR)/$(TESTDIR); perl regression.pl
#	cd $(SRCDIR)/$(TESTDIR); sh regression.sh


# Remove everything made by this makefile

realclean: 
	rm -rf objs *.a


