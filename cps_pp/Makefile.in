# CPS makefile
# $Id: Makefile.in,v 1.15 2004-06-04 21:13:56 chulwoo Exp $
# @configure_input@

SRCDIR = @abs_top_srcdir@
BUILDDIR = @abs_builddir@
TESTDIR = $(SRCDIR)/tests
QOS = @QOS@



all: recurse

cps: recurse

depend: recurse

clean: recurse

buildlib: recurse

recurse:
	mkdir -p $(BUILDDIR)/objs
	touch -a $(BUILDDIR)/objs/Makefile_depend
	cp -p $(SRCDIR)/src/Makefile $(BUILDDIR)/objs
	$(MAKE) -C $(BUILDDIR)/objs $(filter-out test, $(MAKECMDGOALS))


cleanlib: 
	rm -f *.a

copy_makefile:
	cp Makefile Makefile.rules ${SRCDIR}
	cp tests/Makefile_common* ${SRCDIR}/tests

copy_include:
	rm -rf $(BUILDDIR)/include
	cp -r $(SRCDIR)/include $(BUILDDIR)

TESTDIRS :=$(shell ls -p $(SRCDIR)/tests/*/Makefile_regression)
TESTDIRS :=$(dir $(TESTDIRS))
TESTDIRS :=$(subst $(SRCDIR)/tests,,$(TESTDIRS))
TESTDIRS :=$(subst /,,$(TESTDIRS))

copy_testdir: $(TESTDIRS)
	@echo TESTDIRS = $(TESTDIRS)

$(TESTDIRS):
	mkdir -p tests/$@
	cp -p $(SRCDIR)/tests/$@/Makefile_regression  tests/$@

#  Create the documentation

have_doxygen = @have_doxygen@

ifneq "$(have_doxygen)" "yes"

docs webdocs:
	@echo doxygen must be installed to make the documentation.
else

docs:
	cd ${SRCDIR}/doc ; sh mkdocs.sh 
	cd ${SRCDIR}/tests/t_asqtad_pion ; doxygen Doxyfile
	cd ${SRCDIR}/tests/s_spect ; doxygen Doxyfile
	cd ${SRCDIR}/tests/t_gauge_rot ; doxygen Doxyfile


#  Documentation for the web pages
#  (this deletes the source code so that it is not posted on the web)

subdirs = $(dir $(shell ls doc/*/Makefile))
webdocs:
	@echo Creating documentation for the web page
	@echo This will delete all source code
	$(MAKE)  docs
	@rm -rf src include tests
	@for a in $(subdirs); do $(MAKE) -C $$a all clean; done
	chmod o= `ls`
	@find doc -path "*CVS" -prune -o -type d -print | xargs chmod 775
	@find doc -name "*.html" -o -name "*.*ps" -o -name "*.gif" -o -name "*.png" -o -name "*.jp*g" -o -name "*.pdf" -o -name "*.tar.gz" |xargs chmod 644

endif

#  Run the regression test suite

test: cps
	-cp tests/Makefile_common tests/regression.pl ${TESTDIR}
	cd $(TESTDIR) ; perl regression.pl
	cd $(TESTDIR) ; sh regression.sh


# Remove everything made by this makefile

realclean: 
	rm -rf $(BUILDDIR)/objs $(BUILDDIR)/*.a

