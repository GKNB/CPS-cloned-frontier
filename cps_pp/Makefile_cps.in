# $Id: Makefile_cps.in,v 1.15 2004-01-13 20:38:54 chulwoo Exp $
#
#  Template makefile for the Columbia Physics System
#  Need to add autoconf stuff
#
#  Create the library for CPS using: make cps
#
MAKEFILE = Makefile_cps


CC = @CC@
CXX = @CXX@
AR = @AR@
AS = @AS@

CFLAGS = @CFLAGS@
CXXFLAGS = @CXXFLAGS@
ASFLAGS = @ASFLAGS@

INCLUDE_FLAGS = @INCLUDE_FLAGS@

DFLAGS = @DFLAGS@

TOPDIR = @topwd_srcdir@

libcps_CXXFLAGS = $(INCLUDE_FLAGS) $(CXXFLAGS) $(DFLAGS)

#
#   source from specific build options
#
include Makefile_cps_src
cps_obj = $(@ARCH@)


.SUFFIXES:
.SUFFIXES:      .o .C .S

#  go into the subdirectory and compile
%.o:%.C
	cd ${<D}; ${CXX} -c ${<F} $(libcps_CXXFLAGS)

%.o:%.S
	cd ${<D}; 
	$(CC) -E $(libcps_CXXFLAGS) $< > $*.i
	$(AS) $(ASFLAGS) -o $*.o $*.i 
	rm $*.i


#
# make the library for the CPS code
#
cps: $(cps_obj)
	${AR} rcs cps.a ${cps_obj}

.PHONY : cps clean docs depend

# change the makefile ==> recompile
$(cps_obj): $(MAKEFILE) 

cps_SOURCES=  $(cps_obj:.o=.C)


have_doxygen = @have_doxygen@

ifneq "$(have_doxygen)" "yes"

docs webdocs:
	@echo doxygen must be installed to make the documentation.
else

docs:
	@$(SHELL) doc/mkdocs.sh 

#
#  documentation for the web pages
#  (this deletes the source code so that it is not posted on the web)

subdirs = $(dir $(shell ls doc/*/Makefile))
webdocs:
	@echo Creating documentation for the web page
	@echo This will delete all source code
	$(MAKE) -f $(MAKEFILE) docs
	@rm -rf src include tests
	@for a in $(subdirs); do $(MAKE) -C $$a all clean; done
	chmod o= `ls`
	@find doc -path "*CVS" -prune -o -type d -print | xargs chmod 775
	@find doc -name "*.html" -o -name "*.*ps" -o -name "*.gif" -o -name "*.png" -o -name "*.jp*g" -o -name "*.pdf" -o -name "*.tar.gz" |xargs chmod 644

endif

clean:
	rm -f $(cps_obj) cps.a
	@$(SHELL) doc/cleandocs.sh


##
##  run the test suite
##
TEST_DIR = tests

test:
	cd $(TEST_DIR) ; perl regression.pl
	cd $(TEST_DIR) ; sh regression.sh



##
## create dependencies
##
depend:	
	makedepend -f Makefile_depend  $(DFLAGS) $(INCLUDE_FLAGS) $(cps_SOURCES)

include Makefile_depend

