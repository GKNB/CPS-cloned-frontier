# $Id: Makefile_cps.in,v 1.10 2003-10-21 15:34:42 zs Exp $
#
#  Template makefile for the Columbia Physics System
#
#  Create the library for CPS using: make cps
#
MAKEFILE = Makefile_cps

# TARGET_QCDSP = 1 for QCDSP build, 0 otherwise
TARGET_QCDSP = @TARGET_QCDSP@

# PARALLEL = 1 for parallel compilation, 0 for serial compilation 
PARALLEL = @PARALLEL@

top_srcdir = @topwd_srcdir@

INCLUDE_FLAGS := -I$(top_srcdir)  -I$(top_srcdir)/include
ifeq "$(PARALLEL)" "1" 
ifeq "$(TARGET_QCDSP)" "0"
INCLUDE_FLAGS := $(INCLUDE_FLAGS) -I$(top_srcdir)/include/comms
endif
endif

CXX = @CXX@
CXXFLAGS = @CXXFLAGS@ -DTARGET_QCDSP=@TARGET_QCDSP@  $(INCLUDE_FLAGS) 
LIBS = @LIBS@

#
#   source from specific build options
#
include Makefile_cps_src

.SUFFIXES:
.SUFFIXES:      .o .C

#  go into the subdirectory and compile
%.o:%.C
	cd ${<D} ; $(CXX) $(CXXFLAGS) -c  ${<F} 


#
# make the library for the CPS code
#
cps: $(cps_obj)
	ar rcs cps.a $^ 


f_stag_pbp: cps
	$(CXX) $(CXXFLAGS) -c $(top_srcdir)/tests/$@/main.C -o $(top_srcdir)/tests/$@/main.o 
	$(CXX) $(top_srcdir)/tests/$@/main.o cps.a $(LIBS) -o $(top_srcdir)/tests/$@/a.out


.PHONY : cps clean docs webdocs depend

# change the makefile ==> recompile
$(cps_obj): $(MAKEFILE) 

cps_SOURCES=  $(cps_obj:.o=.C)


ifneq "@have_doxygen@" "yes"

docs webdocs:
	@echo doxygen must be installed to make the documentation.
else

docs:
	@$(SHELL) doc/mkdocs.sh 

#
#  documentation for the web pages
#  (this deletes the source code so that it is not posted on the web)

subdirs = $(dir $(shell ls doc/*/Makefile))
webdocs:
	@echo Creating documentation for the web page
	@echo This will delete all source code
	$(MAKE) -f $(MAKEFILE) docs
	@rm -rf src include tests
	@for a in $(subdirs); do $(MAKE) -C $$a all clean; done
	chmod o= `ls`
	@find doc -path "*CVS" -prune -o -type d -print | xargs chmod 775
	@find doc -name "*.html" -o -name "*.*ps" -o -name "*.gif" -o -name "*.png" -o -name "*.jp*g" -o -name "*.pdf" -o -name "*.tar.gz" |xargs chmod 644

endif

clean:
	rm -f $(cps_obj) cps.a
	@$(SHELL) doc/cleandocs.sh


##
##  run the test suite
##
TEST_DIR = tests

test:
	cd $(TEST_DIR) ; perl regression.pl
	cd $(TEST_DIR) ; sh regression.sh


##
## create dependencies
## 
# depend:	
# 	makedepend -f Makefile_depend  $(CXXFLAGS)  $(cps_SOURCES)

depend: 
	$(CXX) -M $(CXXFLAGS) $(cps_SOURCES) |\
	sed -e 's/^.*\.o://g' -e 's/\.C/\.o:/g'  > Makefile_depend

include Makefile_depend

